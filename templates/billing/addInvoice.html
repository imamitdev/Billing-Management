{% extends 'base.html' %}

{% block content %}
<div class="page-wrapper">
  <div class="content container-fluid">
    <div class="page-header invoices-page-header">
      <div class="row align-items-center">
        <div class="col">
          <ul class="breadcrumb invoices-breadcrumb">
            <li class="breadcrumb-item invoices-breadcrumb-item">
              <a href="{% url 'invoice_list' %}">
                <i class="fe fe-chevron-left"></i> Back to Invoice List
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-12">
        <div class="card invoices-add-card">
          <div class="card-body">
            <form method="post" action="{% url 'add_invoice' %}" class="invoices-form">
              {% csrf_token %}
              
              <!-- Management form for the formset -->
              {{ item_forms.management_form }}
              
              <div class="invoices-main-form">
                <div class="row">
                  <div class="col-xl-4 col-md-6 col-sm-12 col-12">
                    <div class="form-group">
                      <div class="multipleSelection">
                          {{ invoice_form.as_p }}
                      </div>
                    </div>
                  </div>
                  <div class="col-xl-5 col-md-6 col-sm-12 col-12">
                    <h4 class="invoice-details-title">Invoice details</h4>
                    <div class="invoice-details-box">
                      <!-- Invoice details here -->
                    </div>
                  </div>
                  <div class="col-xl-3 col-md-12 col-sm-12 col-12"></div>
                </div>
              </div>

              <div class="invoice-item">
                <div class="row">
                  <div class="col-xl-4 col-lg-6 col-md-6">
                    <div class="invoice-info">
                      <strong class="customer-text">Invoice From</strong>
                      <p class="invoice-details invoice-details-two">
                        Darren Elder <br />
                        806 Twin Willow Lane, Old Forge,<br />
                        Newyork, USA <br />
                      </p>
                    </div>
                  </div>
                  <div class="col-xl-4 col-lg-6 col-md-6">
                    <div class="invoice-info">
                      <strong class="customer-text">Invoice To</strong>
                      <p class="invoice-details invoice-details-two">
                        Walter Roberson <br />
                        299 Star Trek Drive, Panama City, <br />
                        Florida, 32405, USA <br />
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="invoice-add-table">
                <h4>Item Details</h4>
                <div class="table-responsive">
                  <table class="table table-center add-table-items">
                    <thead>
                      <tr>
                        <th>Items</th>
                        <th>Quantity</th>
                        <th>Price</th>
                        <th>SGST</th>
                        <th>CGST</th>
                        <th>Amount</th>
                        <th>Total Amount</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="invoice-items-body">
                      {% for item_form in item_forms %}
                        <tr class="add-row">
                          <td>
                            <select name="{{ item_form.prefix }}-product" class="form-control item-product">
                              {% for product in products %}
                                <option value="{{ product.id }}" data-price="{{ product.purchase_price }}" data-sgst="{{ product.sgst_rate }}" data-cgst="{{ product.cgst_rate }}">{{ product.name }}</option>
                              {% endfor %}
                            </select>
                          </td>
                          <td>
                            <input type="number" class="form-control item-quantity" name="{{ item_form.prefix }}-quantity" min="1" value="1" />
                          </td>
                          <td>
                            <input type="text" class="form-control item-price" name="{{ item_form.prefix }}-price" readonly />
                          </td>
                          <td>
                            <input type="text" class="form-control item-sgst" name="{{ item_form.prefix }}-sgst" readonly />
                          </td>
                          <td>
                            <input type="text" class="form-control item-cgst" name="{{ item_form.prefix }}-cgst" readonly />
                          </td>
                          <td>
                            <input type="text" class="form-control item-amount" name="{{ item_form.prefix }}-amount" />
                          </td>
                          <td>
                            <input type="text" class="form-control item-total-amount" name="{{ item_form.prefix }}-total_amount" />
                          </td>
                          <td class="add-remove text-end">
                            <a href="javascript:void(0);" class="add-btn1 me-2"><i class="fas fa-plus-circle"></i></a>
                            <a href="javascript:void(0);" class="copy-btn me-2"><i class="fe fe-copy"></i></a>
                            <a href="javascript:void(0);" class="remove-btn"><i class="fe fe-trash-2"></i></a>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="row">
                <div class="col-lg-7 col-md-6">
                  <div class="invoice-fields">
                    <!-- Any additional fields if needed -->
                  </div>
                </div>
                <div class="col-lg-5 col-md-6">
                  <div class="invoice-total-card">
                    <h4 class="invoice-total-title">Summary</h4>
                    <div class="invoice-total-box">
                      <div class="invoice-total-inner">
                        <p>Total CGST <span id="cgst-amount">$0.00</span></p>
                        <p>Total SGST <span id="sgst-amount">$0.00</span></p>
                        <p>Taxable Amount <span id="taxable-amount">$0.00</span></p>
                      </div>
                      <div class="invoice-total-footer">
                        <h4>Total Amount <span id="total-amount">$0.00</span></h4>
                      </div>
                    </div>
                  </div>
                  <div class="upload-sign">
                    <div class="form-group float-end mb-0">
                      <button class="btn btn-primary" type="submit">Save Invoice</button>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal custom-modal fade invoices-preview" id="invoices_preview" role="dialog">
  <!-- Modal content here -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let rowIndex = document.querySelectorAll('.add-row').length;
    const tableBody = document.getElementById('invoice-items-body');

    function createRow(index) {
        return `...`;  // Your existing createRow function here
    }

    function attachEventHandlers() {
        document.querySelectorAll('.item-product').forEach(select => {
            select.addEventListener('change', function() {
                const row = this.closest('tr');
                const price = this.options[this.selectedIndex].dataset.price;
                const sgst = this.options[this.selectedIndex].dataset.sgst;
                const cgst = this.options[this.selectedIndex].dataset.cgst;
                
                row.querySelector('.item-price').value = price;
                row.querySelector('.item-sgst').value = sgst;
                row.querySelector('.item-cgst').value = cgst;
            });
        });

        document.querySelectorAll('.item-quantity').forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('tr');
                const price = parseFloat(row.querySelector('.item-price').value || 0);
                const quantity = parseFloat(this.value || 0);
                const sgst = parseFloat(row.querySelector('.item-sgst').value || 0);
                const cgst = parseFloat(row.querySelector('.item-cgst').value || 0);
                
                const amount = price * quantity;
                const totalAmount = amount + (amount * sgst / 100) + (amount * cgst / 100);
                
                row.querySelector('.item-amount').value = amount.toFixed(2);
                row.querySelector('.item-total-amount').value = totalAmount.toFixed(2);
                
                updateSummary();
            });
        });
    }

    document.addEventListener('click', function(event) {
        if (event.target && event.target.matches('.add-btn1')) {
            const newRow = createRow(rowIndex++);
            tableBody.insertAdjacentHTML('beforeend', newRow);
            attachEventHandlers();
        }
        
        if (event.target && event.target.matches('.remove-btn')) {
            const row = event.target.closest('tr');
            row.remove();
            updateSummary();
        }
        
        if (event.target && event.target.matches('.copy-btn')) {
            const row = event.target.closest('tr');
            const newRow = row.cloneNode(true);
            tableBody.insertAdjacentElement('beforeend', newRow);
            rowIndex++;
            attachEventHandlers();
        }
    });

    attachEventHandlers();

    function updateSummary() {
        let totalCgst = 0;
        let totalSgst = 0;
        let taxableAmount = 0;

        document.querySelectorAll('.add-row').forEach(row => {
            const sgst = parseFloat(row.querySelector('.item-sgst').value || 0);
            const cgst = parseFloat(row.querySelector('.item-cgst').value || 0);
            const totalAmount = parseFloat(row.querySelector('.item-total-amount').value || 0);

            totalSgst += sgst * totalAmount / 100;
            totalCgst += cgst * totalAmount / 100;
            taxableAmount += totalAmount;
        });

        document.getElementById('cgst-amount').innerText = `$${totalCgst.toFixed(2)}`;
        document.getElementById('sgst-amount').innerText = `$${totalSgst.toFixed(2)}`;
        document.getElementById('taxable-amount').innerText = `$${taxableAmount.toFixed(2)}`;
        document.getElementById('total-amount').innerText = `$${(taxableAmount + totalCgst + totalSgst).toFixed(2)}`;
    }
});

</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      const customerSelect = document.querySelector('select[name="customer"]');
  
      if (customerSelect) {
          customerSelect.addEventListener('change', function() {
              const customerId = this.value;
              console.log('Customer selected:', customerId);
              // Add any additional functionality if needed
          });
      }
  });
</script>
{% endblock %}
